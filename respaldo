Perfecto. Te dejo un **prompt estructurado y completo** para guardar como referencia del estado actual del diseÃ±o (mapa + cluster + foco + polyline). Esto te permitirÃ¡ retomar el contexto exacto en cualquier momento.

---

# ğŸ“Œ PROMPT DE CONTEXTO â€” SISTEMA DE MAPA ROUTES (V1)

Estamos desarrollando una web tipo marketplace de rutas y ofertas con:

* Backend: Symfony (Clean Architecture)
* Frontend: React + CQRS
* Mapas: Leaflet + MarkerCluster
* Solo backend + frontend SPA (sin SSR)
* Datos ya disponibles: routes con polyline codificada, bbox, mÃ©tricas, etc.

---

# ğŸ—ºï¸ ARQUITECTURA DE MAPA PARA ROUTES (DECISIÃ“N FINAL V1)

## 1ï¸âƒ£ Estado Normal (Explore Mode)

Objetivo: exploraciÃ³n libre del mapa.

### Comportamiento:

* Se cargan rutas mediante:

  * `bbox`
  * filtros activos
  * paginaciÃ³n
* Se muestran:

  * Markers individuales
  * MarkerClusters (Leaflet cluster normal)
* NO se pinta polyline en este estado.
* Al mover el mapa â†’ se actualizan rutas.
* Al cambiar filtros â†’ se actualizan rutas.
* Lista lateral sincronizada con bbox.

### Regla:

Modo rÃ¡pido, limpio, sin ruido visual.
Nada de mapa completamente azul.

---

## 2ï¸âƒ£ Click en MarkerCluster â†’ Focus Mode

Objetivo: explorar una zona densa sin ruido tipo Wikiloc.

Al hacer click en un cluster:

* Se activa:

```
focusPoint = { lat, lng }
radius = 100m
```

* Se ignora `bbox`
* Se usan solo:

  * focusPoint + radius
  * filtros activos

### Efecto:

* La lista muestra solo rutas dentro del radio 100m.
* El mapa puede moverse, pero no cambia dataset.
* Aparece botÃ³n tipo:

  * â€œSalir del focoâ€

---

## 3ï¸âƒ£ Ver Polyline (Route View Mode)

Solo disponible dentro del Focus Mode (V1).

Cuando el usuario pulsa:
ğŸ‘‰ â€œVer rutaâ€

Entonces:

* Se pinta polyline.
* Opcional: se centra mapa.
* No afecta filtros.

NO se pinta polyline en modo normal.

---

# ğŸ¯ RAZÃ“N PRINCIPAL

Evitar este problema tÃ­pico (como Wikiloc):

* Muchos markers superpuestos.
* Spiderfy con 20 iconos pegados.
* Mapa visualmente saturado.
* UX confusa.

SoluciÃ³n:

* Cluster normal para limpieza.
* Focus radius fijo de 100m para anÃ¡lisis.
* Polyline solo bajo demanda.

---

# ğŸ“ DECISIÃ“N SOBRE RADIO

Primera versiÃ³n:

```
radius = 100m
```

Razones:

* Agrupa salidas desde mismo parking/entrada.
* Evita fragmentaciÃ³n por GPS impreciso.
* Es robusto para zonas densas.
* MVP sÃ³lido.

Posible mejora futura:

* Radio dinÃ¡mico segÃºn zoom.

---

# ğŸ”„ INTERACCIÃ“N FILTROS + FOCUS

Si focus estÃ¡ activo:

* Aplicar nuevos filtros mantiene el focus.
* Dataset se recalcula dentro del radio.
* El nÃºmero de elementos puede variar.
* Si queda 0 resultados â†’ se mantiene focus activo.

No se abandona automÃ¡ticamente.

---

# ğŸ§  ESTADOS DE FRONTEND

Modelo conceptual:

```
mode: 'explore' | 'focus' | 'route-view'
```

* explore â†’ bbox controla dataset
* focus â†’ radius controla dataset
* route-view â†’ polyline visible

SeparaciÃ³n clara de responsabilidades.

---

# ğŸš« REGLA IMPORTANTE

En modo normal:

* Nunca pintar polylines.
* Nunca mezclar explore y route-view.

Mantener mapa limpio.

---

# ğŸ”¥ RESUMEN

âœ” Cluster normal Leaflet siempre activo
âœ” Click en cluster activa focus 100m
âœ” Bbox ignorado mientras focus activo
âœ” Polyline solo bajo acciÃ³n explÃ­cita
âœ” UX limpia, profesional y escalable
âœ” Evitamos nube de markers estilo Wikiloc
âœ” Arquitectura preparada para crecer

---

Guarda este prompt como:

```
MAP_ARCHITECTURE_V1_ROUTES_FOCUS_SYSTEM
```

Si en el futuro perdemos contexto, solo tienes que pegarlo y seguimos exactamente desde aquÃ­.

---

Si quieres ahora podemos diseÃ±ar cÃ³mo implementar esto correctamente en React con CQRS sin romper el estado global.
